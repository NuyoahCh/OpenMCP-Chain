# OpenMCP-Chain 架构

OpenMCP-Chain 被设计为一个模块化的协议栈，用于以可验证的方式连接大模型智能体与区块链基础设施。架构被划分为明确的领域，以实现独立演进、安全执行和严格的可观测性。

## 核心原则

1. **以智能体为中心的设计** – 系统围绕自主智能体运行，这些智能体基于自然语言指令做出决策，同时遵守确定性策略约束。
2. **安全性与来源可追溯性** – 每个智能体操作都会生成可审计的工件，包括签名的推理结果和链上交易回执。
3. **可扩展性** – 模块通过接口和插件点设计，能够适应新的 LLM 提供商、区块链网络和存储后端。
4. **操作弹性** – 配置管理、可观测性和部署工具强调在异构环境中的可靠性。

## 高级组件

### 智能体运行时（`internal/agent`）

* 实现智能体状态机，包括规划、工具选择和执行循环。
* 集成 LLM 模块进行推理，并与 Web3 模块进行区块链交互。
* 强制执行管理员定义的策略检查和安全约束。

### 大语言模型适配器（`internal/llm`）

* 提供调用第三方 LLM 提供商（如 OpenAI、本地推理后端）的标准化接口。
* 管理提示模板、令牌计数、缓存提示和流式响应。
* 支持未来的去中心化推理市场。

### Web3 交互层（`internal/web3`）

* 抽象 RPC 交互、交易构建、签名和提交，支持的区块链网络。
* 维护钱包集成、nonce 管理和事件订阅。
* 为智能合约读写提供标准化工作流，并具有确定性错误处理。

### 证明与认证（`internal/proofs`）

* 捕获智能体输出和区块链交易的加密签名。
* 提供哈希工具，用于将元数据锚定到链上或去中心化存储网络。
* 为集成零知识证明或可信执行环境奠定基础。

### 存储层（`internal/storage`）

* **MySQL** 存储库持久化智能体会话、任务生命周期、配置文件和区块链回执等数据。
* **Redis** 工具提供低延迟缓存、分布式锁和异步工作负载的任务队列。
* 通用接口使服务与存储细节解耦，并通过模拟简化测试。

### API 网关（`internal/api`）

* 托管 REST 和 gRPC 服务，用于控制智能体、检索日志和查询审计记录。
* 集成身份验证和授权层，保护对敏感功能的访问。
* 为每个请求发出指标、跟踪跨度和结构化日志。

### SDK（`pkg/sdk`）

* 提供类型化的客户端库，供外部系统与 OpenMCP API 通信。
* 封装身份验证流程、重试和错误建模，确保一致的用户体验。

### 部署工具（`deploy/` 和 `scripts/`）

* Dockerfiles、Helm 图表和 Terraform 模块简化了本地开发和生产部署。
* 自动化脚本处理数据库迁移、代码生成和环境引导等任务。

## 运行时流程

1. 外部客户端通过 API 网关提交任务。
2. 智能体运行时验证策略、准备上下文，并向 LLM 提供商请求推理。
3. 智能体将推理结果转换为可执行步骤，并可能通过 Web3 层调用区块链工具。
4. 交易被签名、提交和跟踪；回执和元数据被持久化到 MySQL，而 Redis 维护瞬态状态。
5. 证明模块对最终结果签名，并在需要时将证据锚定到链上。
6. API 网关返回结构化响应，包括来源细节，给调用方。

## 可观测性与操作

* **日志记录** – 结构化、分级日志，跨组件使用相关 ID。
* **指标** – Prometheus 兼容的指标捕获延迟、吞吐量、错误率和资源利用率。
* **跟踪** – OpenTelemetry 仪表化将 API 请求与 LLM 和区块链操作链接起来，实现整体可见性。

## 安全性考量

* 密钥管理集成外部密钥库，保护 API 密钥和私钥。
* 策略强制执行，防止不安全的合约交互或预算超支。
* 审计记录维护所有智能体操作的防篡改记录。

此架构为迭代开发提供了基础，同时将安全性、可扩展性和可靠性置于首位。